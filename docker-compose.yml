# ZK Private Lending - Docker Compose
#
# Full stack development environment
#
# Usage:
#   docker-compose up -d              # Start all services
#   docker-compose logs -f api        # View API logs
#   docker-compose down               # Stop all services
#
# Ports:
#   - 3000: API server
#   - 5173: Frontend (dev)
#   - 5432: PostgreSQL
#   - 8545: Anvil (local Ethereum)
#   - 6379: Redis

version: '3.8'

services:
  # ============ PostgreSQL Database ============
  postgres:
    image: postgres:16-alpine
    container_name: zk-lending-db
    environment:
      POSTGRES_USER: zklending
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-zklending_secret}
      POSTGRES_DB: zk_lending
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./api/migrations:/docker-entrypoint-initdb.d:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U zklending -d zk_lending"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # ============ ZK Lending API ============
  api:
    build:
      context: .
      dockerfile: api/Dockerfile
    container_name: zk-lending-api
    environment:
      # Database
      DATABASE_URL: postgres://zklending:${POSTGRES_PASSWORD:-zklending_secret}@postgres:5432/zk_lending
      # Server
      HOST: 0.0.0.0
      PORT: 3000
      # Logging
      RUST_LOG: info,zk_lending_api=debug
      # ZK Prover
      ZK_PROVER_K: 17
    ports:
      - "3000:3000"
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      start_period: 30s
      retries: 3
    restart: unless-stopped

  # ============ Anvil (Local Ethereum) ============
  anvil:
    image: ghcr.io/foundry-rs/foundry:latest
    container_name: zk-lending-anvil
    command: ["anvil", "--host", "0.0.0.0", "--port", "8545"]
    ports:
      - "8545:8545"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8545"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # ============ Frontend (React) ============
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: zk-lending-frontend
    environment:
      VITE_API_URL: http://localhost:3000
      VITE_CHAIN_ID: "31337"
    ports:
      - "5173:80"
    depends_on:
      - api
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
    profiles:
      - frontend

  # ============ Redis (Optional: Caching) ============
  redis:
    image: redis:7-alpine
    container_name: zk-lending-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    profiles:
      - full

  # ============ Contract Deployer ============
  deployer:
    build:
      context: ./contracts
      dockerfile: Dockerfile.deployer
    container_name: zk-lending-deployer
    environment:
      RPC_URL: http://anvil:8545
      PRIVATE_KEY: "0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80"
    depends_on:
      anvil:
        condition: service_healthy
    profiles:
      - deploy

volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local

networks:
  default:
    name: zk-lending-network
    driver: bridge
